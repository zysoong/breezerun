name: Test Setup Scripts

on:
  push:
    branches: [main, develop, feature/*]
    paths:
      - 'setup.sh'
      - 'setup.ps1'
      - '.github/workflows/setup-test.yml'
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

env:
  PYTHON_VERSION: "3.13"
  NODE_VERSION: "20"

jobs:
  # ============================================
  # Test on Ubuntu Linux
  # ============================================
  test-linux:
    name: Test Setup - Linux (Ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          chmod +x setup.sh
          ./setup.sh --skip-docker

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test tests/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on macOS
  # ============================================
  test-macos:
    name: Test Setup - macOS
    runs-on: macos-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run setup script
        run: |
          chmod +x setup.sh
          ./setup.sh --skip-docker

      - name: Verify Python installation
        run: python3 --version

      - name: Verify Node.js installation
        run: node --version

      - name: Verify Poetry installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Verify backend dependencies
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        working-directory: backend
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry run python -m app.main &
          sleep 10

      - name: Test backend endpoint
        run: |
          curl -f http://localhost:8000/ || exit 1
          curl -f http://localhost:8000/docs || exit 1

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run dev &
          sleep 10

      - name: Install Playwright
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        working-directory: frontend
        run: |
          npx playwright test tests/setup-verification.spec.ts --project=chromium || echo "Playwright test not found, using curl"
          curl -f http://localhost:5173/ || exit 1

  # ============================================
  # Test on Windows
  # ============================================
  test-windows:
    name: Test Setup - Windows
    runs-on: windows-latest
    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Pre-install dependencies for faster CI (skip Chocolatey)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Poetry
        shell: pwsh
        run: |
          (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
          $env:Path += ";$env:APPDATA\Python\Scripts"
          echo "$env:APPDATA\Python\Scripts" >> $env:GITHUB_PATH

      - name: Setup backend
        shell: pwsh
        working-directory: backend
        run: |
          poetry install --with dev

          # Create .env file
          $encryptionKey = python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
          @"
          DATABASE_URL=sqlite+aiosqlite:///./data/breezerun.db
          HOST=127.0.0.1
          PORT=8000
          CORS_ORIGINS=http://localhost:3000,http://localhost:5173,http://localhost:5174
          MASTER_ENCRYPTION_KEY=$encryptionKey
          "@ | Set-Content ".env"

          New-Item -ItemType Directory -Path "data" -Force | Out-Null

      - name: Setup frontend
        shell: pwsh
        working-directory: frontend
        run: npm install

      - name: Verify backend dependencies
        shell: pwsh
        working-directory: backend
        run: |
          poetry run python -c "import fastapi; print('FastAPI OK')"
          poetry run python -c "import litellm; print('LiteLLM OK')"

      - name: Verify frontend dependencies
        shell: pwsh
        working-directory: frontend
        run: |
          npm list vite
          npm list react

      - name: Start backend server
        shell: pwsh
        working-directory: backend
        run: |
          Start-Process -NoNewWindow -FilePath "poetry" -ArgumentList "run", "python", "-m", "app.main"
          Start-Sleep -Seconds 15

      - name: Test backend endpoint
        shell: pwsh
        run: |
          $response = Invoke-WebRequest -Uri http://localhost:8000/ -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }
          Write-Host "Backend is accessible!"

      - name: Start frontend server
        shell: pwsh
        working-directory: frontend
        run: |
          Start-Process -NoNewWindow -FilePath "npm" -ArgumentList "run", "dev"
          Start-Sleep -Seconds 15

      - name: Install Playwright
        shell: pwsh
        working-directory: frontend
        run: |
          npx playwright install chromium --with-deps

      - name: Test frontend accessibility
        shell: pwsh
        working-directory: frontend
        run: |
          try {
            npx playwright test tests/setup-verification.spec.ts --project=chromium
          } catch {
            Write-Host "Playwright test not found, using Invoke-WebRequest"
          }
          $response = Invoke-WebRequest -Uri http://localhost:5173/ -UseBasicParsing
          if ($response.StatusCode -ne 200) { exit 1 }
          Write-Host "Frontend is accessible!"
